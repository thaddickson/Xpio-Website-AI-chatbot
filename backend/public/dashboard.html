<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Chatbot Platform</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 250px;
      background: #2B2B2B;
      color: white;
      padding: 20px 0;
      z-index: 100;
    }

    .sidebar-logo {
      padding: 0 20px 20px;
      border-bottom: 1px solid #444;
      margin-bottom: 20px;
    }

    .sidebar-logo h1 {
      font-size: 20px;
      color: #667eea;
    }

    .sidebar-logo .tenant-name {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }

    .sidebar-nav {
      list-style: none;
    }

    .sidebar-nav li {
      margin-bottom: 4px;
    }

    .sidebar-nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: #aaa;
      text-decoration: none;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .sidebar-nav a:hover {
      background: rgba(255,255,255,0.05);
      color: white;
    }

    .sidebar-nav a.active {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border-left-color: #667eea;
    }

    .sidebar-nav .icon {
      font-size: 18px;
    }

    .sidebar-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      border-top: 1px solid #444;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: #667eea;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .user-role {
      font-size: 11px;
      color: #888;
    }

    /* Main Content */
    .main-content {
      margin-left: 250px;
      padding: 30px;
      min-height: 100vh;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #333;
      border: 1px solid #ddd;
    }

    .btn-secondary:hover {
      background: #f5f5f5;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }

    .stat-change {
      font-size: 12px;
      margin-top: 8px;
    }

    .stat-change.positive { color: #10b981; }
    .stat-change.negative { color: #ef4444; }

    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .card-body {
      padding: 24px;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Widget Embed Code */
    .embed-code {
      background: #2B2B2B;
      color: #10b981;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      position: relative;
    }

    .embed-code .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    /* API Keys Table */
    .keys-table {
      width: 100%;
      border-collapse: collapse;
    }

    .keys-table th,
    .keys-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .keys-table th {
      font-weight: 600;
      color: #666;
      font-size: 12px;
      text-transform: uppercase;
    }

    .key-value {
      font-family: 'Courier New', monospace;
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-success { background: #d1fae5; color: #059669; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-danger { background: #fee2e2; color: #dc2626; }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* Color Picker */
    .color-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .color-input input[type="color"] {
      width: 50px;
      height: 40px;
      padding: 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .color-input input[type="text"] {
      flex: 1;
    }

    /* Team Members List */
    .team-member {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid #eee;
    }

    .team-member:last-child {
      border-bottom: none;
    }

    .member-avatar {
      width: 40px;
      height: 40px;
      background: #667eea;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-weight: 600;
    }

    .member-email {
      font-size: 13px;
      color: #666;
    }

    /* Plan Card */
    .plan-info {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      color: white;
      margin-bottom: 20px;
    }

    .plan-info h3 {
      font-size: 24px;
    }

    .plan-info .usage {
      margin-left: auto;
      text-align: right;
    }

    .progress-bar {
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
      margin-top: 8px;
      width: 200px;
    }

    .progress-bar .fill {
      height: 100%;
      background: white;
      border-radius: 4px;
      transition: width 0.3s;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #666;
      cursor: pointer;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .main-content {
        margin-left: 0;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <h1>Chatbot Platform</h1>
      <div class="tenant-name" id="tenantName">Loading...</div>
    </div>

    <ul class="sidebar-nav">
      <li><a href="#overview" class="active" onclick="switchTab('overview')"><span class="icon">&#128200;</span> Overview</a></li>
      <li><a href="#widget" onclick="switchTab('widget')"><span class="icon">&#128172;</span> Widget Setup</a></li>
      <li><a href="#prompts" onclick="switchTab('prompts')"><span class="icon">&#128221;</span> Prompts</a></li>
      <li><a href="#api-keys" onclick="switchTab('api-keys')"><span class="icon">&#128273;</span> API Keys</a></li>
      <li><a href="#team" onclick="switchTab('team')"><span class="icon">&#128101;</span> Team</a></li>
      <li><a href="#settings" onclick="switchTab('settings')"><span class="icon">&#9881;</span> Settings</a></li>
      <li><a href="#billing" onclick="switchTab('billing')"><span class="icon">&#128179;</span> Billing</a></li>
    </ul>

    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-details">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-role" id="userRole">-</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active">
      <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <button class="btn btn-primary" onclick="window.open('admin.html', '_blank')">Open Prompt Editor</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statConversations">-</div>
          <div class="stat-label">Conversations This Month</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statLeads">-</div>
          <div class="stat-label">Leads Captured</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statConversion">-</div>
          <div class="stat-label">Conversion Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statLimit">-</div>
          <div class="stat-label">Monthly Limit</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Quick Start</h3>
        </div>
        <div class="card-body">
          <p style="margin-bottom: 15px;">Add this code to your website to display the chatbot:</p>
          <div class="embed-code" id="embedCodeOverview">
            <button class="copy-btn" onclick="copyEmbedCode()">Copy</button>
            Loading...
          </div>
        </div>
      </div>
    </div>

    <!-- Widget Setup Tab -->
    <div id="widget-tab" class="tab-content">
      <div class="page-header">
        <h1 class="page-title">Widget Setup</h1>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Embed Code</h3>
        </div>
        <div class="card-body">
          <p style="margin-bottom: 15px;">Copy and paste this code into your website's HTML, just before the closing <code>&lt;/body&gt;</code> tag:</p>
          <div class="embed-code" id="embedCode">
            <button class="copy-btn" onclick="copyEmbedCode()">Copy</button>
            Loading...
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Branding</h3>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label>Chat Title</label>
              <input type="text" id="chatTitle" placeholder="Chat with us">
            </div>
            <div class="form-group">
              <label>Primary Color</label>
              <div class="color-input">
                <input type="color" id="primaryColor" value="#667eea">
                <input type="text" id="primaryColorHex" value="#667eea">
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Greeting Message</label>
            <textarea id="greeting" rows="3" placeholder="Hi! How can I help you today?"></textarea>
          </div>
          <button class="btn btn-primary" onclick="saveBranding()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Prompts Tab -->
    <div id="prompts-tab" class="tab-content">
      <div class="page-header">
        <h1 class="page-title">Prompts</h1>
        <button class="btn btn-primary" onclick="window.open('admin.html', '_blank')">Open Full Editor</button>
      </div>

      <div class="card">
        <div class="card-body" style="text-align: center; padding: 60px;">
          <p style="font-size: 48px; margin-bottom: 20px;">&#128221;</p>
          <h3 style="margin-bottom: 10px;">Manage Your Chatbot's Knowledge</h3>
          <p style="color: #666; margin-bottom: 20px;">Use the full prompt editor to customize what your chatbot knows and how it responds.</p>
          <button class="btn btn-primary" onclick="window.open('admin.html', '_blank')">Open Prompt Editor</button>
        </div>
      </div>
    </div>

    <!-- API Keys Tab -->
    <div id="api-keys-tab" class="tab-content">
      <div class="page-header">
        <h1 class="page-title">API Keys</h1>
        <button class="btn btn-primary" onclick="showCreateKeyModal()">+ Create New Key</button>
      </div>

      <div class="card">
        <div class="card-body">
          <table class="keys-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Key</th>
                <th>Type</th>
                <th>Last Used</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="keysTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #666;">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Team Tab -->
    <div id="team-tab" class="tab-content">
      <div class="page-header">
        <h1 class="page-title">Team</h1>
        <button class="btn btn-primary" onclick="showInviteModal()">+ Invite Member</button>
      </div>

      <div class="card">
        <div class="card-body" id="teamList">
          <div style="text-align: center; padding: 40px; color: #666;">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="page-header">
        <h1 class="page-title">Settings</h1>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Company Information</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Company Name</label>
            <input type="text" id="companyName">
          </div>
          <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Integrations</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Calendly URL (for meeting scheduling)</label>
            <input type="text" id="calendlyUrl" placeholder="https://calendly.com/your-link">
          </div>
          <div class="form-group">
            <label>Slack Channel ID</label>
            <input type="text" id="slackChannelId" placeholder="C1234567890">
          </div>
          <div class="form-group">
            <label>Notification Emails (comma-separated)</label>
            <input type="text" id="notificationEmails" placeholder="team@company.com, sales@company.com">
          </div>
          <button class="btn btn-primary" onclick="saveIntegrations()">Save Integrations</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Danger Zone</h3>
        </div>
        <div class="card-body">
          <p style="color: #666; margin-bottom: 15px;">Once you delete your account, there is no going back.</p>
          <button class="btn btn-danger">Delete Account</button>
        </div>
      </div>
    </div>

    <!-- Billing Tab -->
    <div id="billing-tab" class="tab-content">
      <div class="page-header">
        <h1 class="page-title">Billing</h1>
      </div>

      <div class="plan-info">
        <div>
          <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">CURRENT PLAN</div>
          <h3 id="currentPlan">Free</h3>
        </div>
        <div class="usage">
          <div id="usageText">0 / 100 conversations</div>
          <div class="progress-bar">
            <div class="fill" id="usageBar" style="width: 0%"></div>
          </div>
        </div>
        <button class="btn" style="background: white; color: #667eea;">Upgrade Plan</button>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Available Plans</h3>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div style="border: 2px solid #eee; border-radius: 12px; padding: 24px; text-align: center;">
              <h4>Free</h4>
              <div style="font-size: 32px; font-weight: 700; margin: 10px 0;">$0</div>
              <ul style="list-style: none; font-size: 14px; color: #666;">
                <li>100 conversations/mo</li>
                <li>3 prompt sections</li>
                <li>1 team member</li>
              </ul>
            </div>
            <div style="border: 2px solid #eee; border-radius: 12px; padding: 24px; text-align: center;">
              <h4>Starter</h4>
              <div style="font-size: 32px; font-weight: 700; margin: 10px 0;">$29</div>
              <ul style="list-style: none; font-size: 14px; color: #666;">
                <li>1,000 conversations/mo</li>
                <li>10 prompt sections</li>
                <li>Slack integration</li>
              </ul>
            </div>
            <div style="border: 2px solid #667eea; border-radius: 12px; padding: 24px; text-align: center; background: rgba(102,126,234,0.05);">
              <h4 style="color: #667eea;">Pro</h4>
              <div style="font-size: 32px; font-weight: 700; margin: 10px 0; color: #667eea;">$99</div>
              <ul style="list-style: none; font-size: 14px; color: #666;">
                <li>10,000 conversations/mo</li>
                <li>A/B Testing</li>
                <li>Custom domain</li>
              </ul>
            </div>
            <div style="border: 2px solid #eee; border-radius: 12px; padding: 24px; text-align: center;">
              <h4>Enterprise</h4>
              <div style="font-size: 32px; font-weight: 700; margin: 10px 0;">Custom</div>
              <ul style="list-style: none; font-size: 14px; color: #666;">
                <li>Unlimited everything</li>
                <li>Priority support</li>
                <li>SLA guarantee</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Create API Key Modal -->
  <div class="modal" id="createKeyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Create API Key</h3>
        <button class="close-btn" onclick="closeModal('createKeyModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Key Name</label>
        <input type="text" id="newKeyName" placeholder="e.g., Production Website">
      </div>
      <div class="form-group">
        <label>Key Type</label>
        <select id="newKeyType">
          <option value="publishable">Publishable (for widgets)</option>
          <option value="secret">Secret (for server-side API)</option>
        </select>
      </div>
      <button class="btn btn-primary" style="width: 100%;" onclick="createApiKey()">Create Key</button>
    </div>
  </div>

  <!-- Invite Member Modal -->
  <div class="modal" id="inviteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Invite Team Member</h3>
        <button class="close-btn" onclick="closeModal('inviteModal')">&times;</button>
      </div>
      <div class="form-group">
        <label>Email Address</label>
        <input type="email" id="inviteEmail" placeholder="colleague@company.com">
      </div>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="inviteName" placeholder="John Smith">
      </div>
      <div class="form-group">
        <label>Role</label>
        <select id="inviteRole">
          <option value="admin">Admin - Full access</option>
          <option value="editor">Editor - Can edit prompts</option>
          <option value="viewer">Viewer - Read only</option>
        </select>
      </div>
      <button class="btn btn-primary" style="width: 100%;" onclick="inviteMember()">Send Invitation</button>
    </div>
  </div>

  <!-- New API Key Display Modal -->
  <div class="modal" id="newKeyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Your New API Key</h3>
        <button class="close-btn" onclick="closeModal('newKeyModal')">&times;</button>
      </div>
      <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 14px; color: #92400e;">
        <strong>Important:</strong> Copy this key now. It won't be shown again!
      </div>
      <div class="embed-code" id="newKeyDisplay" style="word-break: break-all;">
        <button class="copy-btn" onclick="copyNewKey()">Copy</button>
        -
      </div>
      <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="closeModal('newKeyModal')">Done</button>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let tenant = null;
    let user = null;

    // Check authentication
    function getAuthHeaders() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        window.location.href = 'login.html';
        return null;
      }
      return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
    }

    // Initialize dashboard
    async function init() {
      const headers = getAuthHeaders();
      if (!headers) return;

      try {
        // Load tenant info
        const tenantRes = await fetch(`${API_URL}/api/tenant`, { headers });
        if (!tenantRes.ok) throw new Error('Failed to load tenant');
        const tenantData = await tenantRes.json();
        tenant = tenantData.tenant;

        // Update UI
        document.getElementById('tenantName').textContent = tenant.name;
        document.getElementById('companyName').value = tenant.name;
        document.getElementById('chatTitle').value = tenant.settings?.branding?.chatTitle || '';
        document.getElementById('greeting').value = tenant.settings?.branding?.greeting || '';
        document.getElementById('primaryColor').value = tenant.settings?.branding?.primaryColor || '#667eea';
        document.getElementById('primaryColorHex').value = tenant.settings?.branding?.primaryColor || '#667eea';

        // Update stats
        document.getElementById('statConversations').textContent = tenant.usage?.currentMonthConversations || 0;
        document.getElementById('statLimit').textContent = tenant.usage?.limits?.monthlyConversations === -1 ? 'Unlimited' : tenant.usage?.limits?.monthlyConversations || 100;
        document.getElementById('currentPlan').textContent = capitalize(tenant.planType);

        const usage = tenant.usage?.currentMonthConversations || 0;
        const limit = tenant.usage?.limits?.monthlyConversations || 100;
        const percentage = limit === -1 ? 0 : Math.min((usage / limit) * 100, 100);
        document.getElementById('usageText').textContent = limit === -1 ? `${usage} conversations (unlimited)` : `${usage} / ${limit} conversations`;
        document.getElementById('usageBar').style.width = `${percentage}%`;

        // Update embed code
        updateEmbedCode();

        // Load API keys
        loadApiKeys();

        // Load team
        loadTeam();

        // Get user from token
        const tokenParts = localStorage.getItem('accessToken').split('.');
        if (tokenParts.length === 3) {
          const payload = JSON.parse(atob(tokenParts[1]));
          document.getElementById('userName').textContent = payload.email?.split('@')[0] || 'User';
          document.getElementById('userAvatar').textContent = (payload.email?.[0] || 'U').toUpperCase();
          document.getElementById('userRole').textContent = capitalize(payload.role || 'admin');
        }

      } catch (error) {
        console.error('Init error:', error);
        // Token might be expired
        localStorage.removeItem('accessToken');
        window.location.href = 'login.html';
      }
    }

    function updateEmbedCode() {
      const apiKeys = document.querySelectorAll('.key-value');
      let apiKey = apiKeys.length > 0 ? apiKeys[0].textContent : 'YOUR_API_KEY';

      // Try to get from stored keys
      if (localStorage.getItem('firstApiKey')) {
        apiKey = localStorage.getItem('firstApiKey');
      }

      const code = `<script src="${API_URL}/chat-widget.js"><\/script>
<script>XpioChatbot.init({ apiKey: '${apiKey}' });<\/script>`;

      document.getElementById('embedCode').innerHTML = `<button class="copy-btn" onclick="copyEmbedCode()">Copy</button><pre>${escapeHtml(code)}</pre>`;
      document.getElementById('embedCodeOverview').innerHTML = `<button class="copy-btn" onclick="copyEmbedCode()">Copy</button><pre>${escapeHtml(code)}</pre>`;
    }

    async function loadApiKeys() {
      const headers = getAuthHeaders();
      if (!headers) return;

      try {
        const res = await fetch(`${API_URL}/api/tenant/api-keys`, { headers });
        const data = await res.json();

        const tbody = document.getElementById('keysTableBody');

        if (!data.keys || data.keys.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">No API keys yet. Create one to get started.</td></tr>';
          return;
        }

        // Store first key for embed code
        if (data.keys.length > 0) {
          localStorage.setItem('firstApiKey', data.keys[0].keyPrefix + '...');
        }

        tbody.innerHTML = data.keys.map(key => `
          <tr>
            <td>${escapeHtml(key.name)}</td>
            <td><span class="key-value">${key.keyPrefix}...</span></td>
            <td>${key.keyType}</td>
            <td>${key.lastUsedAt ? new Date(key.lastUsedAt).toLocaleDateString() : 'Never'}</td>
            <td><span class="badge ${key.isActive ? 'badge-success' : 'badge-danger'}">${key.isActive ? 'Active' : 'Revoked'}</span></td>
            <td>
              ${key.isActive ? `<button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;" onclick="revokeKey('${key.id}')">Revoke</button>` : ''}
            </td>
          </tr>
        `).join('');

        updateEmbedCode();
      } catch (error) {
        console.error('Error loading API keys:', error);
      }
    }

    async function loadTeam() {
      const headers = getAuthHeaders();
      if (!headers) return;

      try {
        const res = await fetch(`${API_URL}/api/tenant/team`, { headers });
        const data = await res.json();

        const container = document.getElementById('teamList');

        if (!data.members || data.members.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No team members yet.</div>';
          return;
        }

        container.innerHTML = data.members.map(member => `
          <div class="team-member">
            <div class="member-avatar">${(member.name?.[0] || member.email[0]).toUpperCase()}</div>
            <div class="member-info">
              <div class="member-name">${escapeHtml(member.name || member.email)}</div>
              <div class="member-email">${escapeHtml(member.email)}</div>
            </div>
            <span class="badge ${member.status === 'active' ? 'badge-success' : 'badge-warning'}">${member.status}</span>
            <span class="badge badge-success">${member.role}</span>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading team:', error);
      }
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.sidebar-nav a').forEach(el => el.classList.remove('active'));

      document.getElementById(`${tabName}-tab`).classList.add('active');
      document.querySelector(`[href="#${tabName}"]`).classList.add('active');
    }

    // Modal functions
    function showCreateKeyModal() {
      document.getElementById('createKeyModal').classList.add('active');
    }

    function showInviteModal() {
      document.getElementById('inviteModal').classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // API Key functions
    async function createApiKey() {
      const headers = getAuthHeaders();
      if (!headers) return;

      const name = document.getElementById('newKeyName').value.trim();
      const keyType = document.getElementById('newKeyType').value;

      if (!name) {
        alert('Please enter a key name');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/tenant/api-keys`, {
          method: 'POST',
          headers,
          body: JSON.stringify({ name, keyType })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.message || 'Failed to create key');

        // Show the new key
        document.getElementById('newKeyDisplay').innerHTML = `<button class="copy-btn" onclick="copyNewKey()">Copy</button>${data.key}`;
        closeModal('createKeyModal');
        document.getElementById('newKeyModal').classList.add('active');

        // Reload keys
        loadApiKeys();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function revokeKey(keyId) {
      if (!confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) return;

      const headers = getAuthHeaders();
      if (!headers) return;

      try {
        await fetch(`${API_URL}/api/tenant/api-keys/${keyId}`, {
          method: 'DELETE',
          headers
        });
        loadApiKeys();
      } catch (error) {
        alert('Error revoking key: ' + error.message);
      }
    }

    function copyNewKey() {
      const key = document.getElementById('newKeyDisplay').textContent.replace('Copy', '').trim();
      navigator.clipboard.writeText(key);
      alert('Copied to clipboard!');
    }

    // Team functions
    async function inviteMember() {
      const headers = getAuthHeaders();
      if (!headers) return;

      const email = document.getElementById('inviteEmail').value.trim();
      const name = document.getElementById('inviteName').value.trim();
      const role = document.getElementById('inviteRole').value;

      if (!email) {
        alert('Please enter an email address');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/tenant/team/invite`, {
          method: 'POST',
          headers,
          body: JSON.stringify({ email, name, role })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.message || 'Failed to invite member');

        closeModal('inviteModal');
        loadTeam();
        alert('Invitation sent!');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Settings functions
    async function saveBranding() {
      const headers = getAuthHeaders();
      if (!headers) return;

      try {
        await fetch(`${API_URL}/api/tenant/settings`, {
          method: 'PUT',
          headers,
          body: JSON.stringify({
            branding: {
              chatTitle: document.getElementById('chatTitle').value,
              greeting: document.getElementById('greeting').value,
              primaryColor: document.getElementById('primaryColor').value
            }
          })
        });
        alert('Branding saved!');
      } catch (error) {
        alert('Error saving: ' + error.message);
      }
    }

    async function saveSettings() {
      const headers = getAuthHeaders();
      if (!headers) return;

      try {
        await fetch(`${API_URL}/api/tenant/settings`, {
          method: 'PUT',
          headers,
          body: JSON.stringify({
            name: document.getElementById('companyName').value
          })
        });
        alert('Settings saved!');
        init(); // Reload
      } catch (error) {
        alert('Error saving: ' + error.message);
      }
    }

    async function saveIntegrations() {
      const headers = getAuthHeaders();
      if (!headers) return;

      try {
        await fetch(`${API_URL}/api/tenant/integrations`, {
          method: 'PUT',
          headers,
          body: JSON.stringify({
            calendlyUrl: document.getElementById('calendlyUrl').value,
            slackChannelId: document.getElementById('slackChannelId').value,
            notificationEmails: document.getElementById('notificationEmails').value.split(',').map(e => e.trim()).filter(e => e)
          })
        });
        alert('Integrations saved!');
      } catch (error) {
        alert('Error saving: ' + error.message);
      }
    }

    // Utility functions
    function copyEmbedCode() {
      const code = document.querySelector('#embedCode pre, #embedCodeOverview pre').textContent;
      navigator.clipboard.writeText(code);
      alert('Copied to clipboard!');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Color picker sync
    document.getElementById('primaryColor').addEventListener('input', (e) => {
      document.getElementById('primaryColorHex').value = e.target.value;
    });

    document.getElementById('primaryColorHex').addEventListener('input', (e) => {
      if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
        document.getElementById('primaryColor').value = e.target.value;
      }
    });

    // Initialize
    init();
  </script>
</body>
</html>
