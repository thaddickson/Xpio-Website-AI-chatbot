<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Your Chatbot - Sign Up</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .signup-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 500px;
      overflow: hidden;
    }

    .signup-header {
      background: #2B2B2B;
      color: white;
      padding: 30px;
      text-align: center;
    }

    .signup-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .signup-header p {
      opacity: 0.8;
      font-size: 14px;
    }

    .signup-form {
      padding: 30px;
    }

    .form-step {
      display: none;
    }

    .form-step.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ddd;
      transition: all 0.3s;
    }

    .step-dot.active {
      background: #667eea;
      transform: scale(1.2);
    }

    .step-dot.completed {
      background: #10b981;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input.error {
      border-color: #ef4444;
    }

    .input-hint {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
    }

    .input-error {
      font-size: 12px;
      color: #ef4444;
      margin-top: 6px;
      display: none;
    }

    .slug-preview {
      display: flex;
      align-items: center;
      gap: 0;
      margin-top: 8px;
      background: #f5f5f5;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 14px;
    }

    .slug-preview .domain {
      color: #666;
    }

    .slug-preview .slug {
      color: #667eea;
      font-weight: 600;
    }

    .slug-status {
      margin-left: auto;
      font-size: 12px;
    }

    .slug-status.available {
      color: #10b981;
    }

    .slug-status.taken {
      color: #ef4444;
    }

    .slug-status.checking {
      color: #666;
    }

    .btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: #e5e5e5;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    .btn-group .btn {
      flex: 1;
    }

    .divider {
      text-align: center;
      margin: 20px 0;
      color: #999;
      font-size: 14px;
    }

    .plan-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .plan-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .plan-option:hover {
      border-color: #667eea;
    }

    .plan-option.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .plan-option h3 {
      font-size: 16px;
      margin-bottom: 4px;
    }

    .plan-option .price {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }

    .plan-option .price span {
      font-size: 14px;
      font-weight: 400;
      color: #666;
    }

    .plan-option .features {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    .success-message {
      text-align: center;
      padding: 20px;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #10b981;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 40px;
      color: white;
    }

    .api-key-display {
      background: #2B2B2B;
      color: #10b981;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
      margin: 20px 0;
      position: relative;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .copy-btn:hover {
      background: #555;
    }

    .warning-box {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: #92400e;
      margin-bottom: 20px;
    }

    .login-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #666;
    }

    .login-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    .login-link a:hover {
      text-decoration: underline;
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #ef4444;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="signup-container">
    <div class="signup-header">
      <h1>Create Your Chatbot</h1>
      <p>Set up your AI-powered lead generation chatbot in minutes</p>
    </div>

    <div class="signup-form">
      <div class="step-indicator">
        <div class="step-dot active" id="dot-1"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-dot" id="dot-3"></div>
      </div>

      <div id="error-message" class="error-message"></div>

      <!-- Step 1: Company Info -->
      <div class="form-step active" id="step-1">
        <h2 style="margin-bottom: 20px; font-size: 20px;">Tell us about your company</h2>

        <div class="form-group">
          <label for="companyName">Company Name</label>
          <input type="text" id="companyName" placeholder="Acme Inc" required>
        </div>

        <div class="form-group">
          <label for="companySlug">Choose your chatbot URL</label>
          <input type="text" id="companySlug" placeholder="acme" pattern="[a-z0-9-]+" required>
          <div class="slug-preview">
            <span class="domain">chat.yourplatform.com/</span>
            <span class="slug" id="slugPreview">your-company</span>
            <span class="slug-status" id="slugStatus"></span>
          </div>
          <div class="input-hint">Only lowercase letters, numbers, and hyphens</div>
        </div>

        <button type="button" class="btn btn-primary" onclick="nextStep(2)">Continue</button>

        <div class="login-link">
          Already have an account? <a href="login.html">Log in</a>
        </div>
      </div>

      <!-- Step 2: Account Info -->
      <div class="form-step" id="step-2">
        <h2 style="margin-bottom: 20px; font-size: 20px;">Create your account</h2>

        <div class="form-group">
          <label for="fullName">Your Name</label>
          <input type="text" id="fullName" placeholder="John Smith" required>
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="john@acme.com" required>
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="At least 8 characters" minlength="8" required>
          <div class="input-hint">Minimum 8 characters</div>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="prevStep(1)">Back</button>
          <button type="button" class="btn btn-primary" onclick="nextStep(3)">Continue</button>
        </div>
      </div>

      <!-- Step 3: Plan Selection -->
      <div class="form-step" id="step-3">
        <h2 style="margin-bottom: 20px; font-size: 20px;">Choose your plan</h2>

        <div class="plan-selector">
          <div class="plan-option selected" data-plan="free" onclick="selectPlan('free')">
            <h3>Free</h3>
            <div class="price">$0<span>/mo</span></div>
            <div class="features">100 conversations/mo<br>3 prompt sections</div>
          </div>
          <div class="plan-option" data-plan="starter" onclick="selectPlan('starter')">
            <h3>Starter</h3>
            <div class="price">$29<span>/mo</span></div>
            <div class="features">1,000 conversations/mo<br>Slack integration</div>
          </div>
          <div class="plan-option" data-plan="pro" onclick="selectPlan('pro')">
            <h3>Pro</h3>
            <div class="price">$99<span>/mo</span></div>
            <div class="features">10,000 conversations/mo<br>A/B testing, Custom domain</div>
          </div>
          <div class="plan-option" data-plan="enterprise" onclick="selectPlan('enterprise')">
            <h3>Enterprise</h3>
            <div class="price">Custom</div>
            <div class="features">Unlimited everything<br>Priority support</div>
          </div>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="prevStep(2)">Back</button>
          <button type="button" class="btn btn-primary" id="createBtn" onclick="createAccount()">
            Create Account
          </button>
        </div>
      </div>

      <!-- Step 4: Success -->
      <div class="form-step" id="step-4">
        <div class="success-message">
          <div class="success-icon">&#10003;</div>
          <h2 style="margin-bottom: 10px;">Welcome aboard!</h2>
          <p style="color: #666; margin-bottom: 20px;">Your chatbot is ready. Here's your API key:</p>

          <div class="warning-box">
            <strong>Important:</strong> Save this API key now! It won't be shown again.
          </div>

          <div class="api-key-display" id="apiKeyDisplay">
            pk_live_yourcompany_xxxxxxxxxxxx
            <button class="copy-btn" onclick="copyApiKey()">Copy</button>
          </div>

          <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
            Add this to your website to start capturing leads:
          </p>

          <div class="api-key-display" style="color: #aaa; font-size: 12px;">
&lt;script src="<span id="scriptUrl"></span>/chat-widget.js"&gt;&lt;/script&gt;
&lt;script&gt;XpioChatbot.init({ apiKey: '<span id="embedApiKey"></span>' });&lt;/script&gt;
          </div>

          <button class="btn btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let currentStep = 1;
    let selectedPlan = 'free';
    let slugCheckTimeout = null;
    let isSlugAvailable = false;
    let registrationData = {};

    // Auto-generate slug from company name
    document.getElementById('companyName').addEventListener('input', (e) => {
      const slug = e.target.value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-|-$/g, '');

      document.getElementById('companySlug').value = slug;
      updateSlugPreview(slug);
      checkSlugAvailability(slug);
    });

    // Manual slug input
    document.getElementById('companySlug').addEventListener('input', (e) => {
      const slug = e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
      e.target.value = slug;
      updateSlugPreview(slug);
      checkSlugAvailability(slug);
    });

    function updateSlugPreview(slug) {
      document.getElementById('slugPreview').textContent = slug || 'your-company';
    }

    function checkSlugAvailability(slug) {
      clearTimeout(slugCheckTimeout);

      if (!slug || slug.length < 3) {
        document.getElementById('slugStatus').textContent = '';
        isSlugAvailable = false;
        return;
      }

      document.getElementById('slugStatus').textContent = 'Checking...';
      document.getElementById('slugStatus').className = 'slug-status checking';

      slugCheckTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`${API_URL}/api/tenants/check-slug/${slug}`);
          const data = await response.json();

          if (data.available) {
            document.getElementById('slugStatus').textContent = 'Available!';
            document.getElementById('slugStatus').className = 'slug-status available';
            isSlugAvailable = true;
          } else {
            document.getElementById('slugStatus').textContent = 'Taken';
            document.getElementById('slugStatus').className = 'slug-status taken';
            isSlugAvailable = false;
          }
        } catch (error) {
          console.error('Error checking slug:', error);
        }
      }, 500);
    }

    function selectPlan(plan) {
      selectedPlan = plan;
      document.querySelectorAll('.plan-option').forEach(el => {
        el.classList.remove('selected');
      });
      document.querySelector(`[data-plan="${plan}"]`).classList.add('selected');
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    function validateStep(step) {
      if (step === 1) {
        const companyName = document.getElementById('companyName').value.trim();
        const slug = document.getElementById('companySlug').value.trim();

        if (!companyName) {
          showError('Please enter your company name');
          return false;
        }
        if (!slug || slug.length < 3) {
          showError('Please enter a valid URL slug (at least 3 characters)');
          return false;
        }
        if (!isSlugAvailable) {
          showError('This URL is not available. Please choose another.');
          return false;
        }
      }

      if (step === 2) {
        const name = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!name) {
          showError('Please enter your name');
          return false;
        }
        if (!email || !email.includes('@')) {
          showError('Please enter a valid email address');
          return false;
        }
        if (!password || password.length < 8) {
          showError('Password must be at least 8 characters');
          return false;
        }
      }

      return true;
    }

    function nextStep(step) {
      if (!validateStep(currentStep)) return;

      // Save data from current step
      if (currentStep === 1) {
        registrationData.tenantName = document.getElementById('companyName').value.trim();
        registrationData.tenantSlug = document.getElementById('companySlug').value.trim();
      }
      if (currentStep === 2) {
        registrationData.name = document.getElementById('fullName').value.trim();
        registrationData.email = document.getElementById('email').value.trim();
        registrationData.password = document.getElementById('password').value;
      }

      // Update step indicators
      document.getElementById(`dot-${currentStep}`).classList.remove('active');
      document.getElementById(`dot-${currentStep}`).classList.add('completed');
      document.getElementById(`dot-${step}`).classList.add('active');

      // Switch steps
      document.getElementById(`step-${currentStep}`).classList.remove('active');
      document.getElementById(`step-${step}`).classList.add('active');

      currentStep = step;
    }

    function prevStep(step) {
      document.getElementById(`dot-${currentStep}`).classList.remove('active');
      document.getElementById(`dot-${step}`).classList.remove('completed');
      document.getElementById(`dot-${step}`).classList.add('active');

      document.getElementById(`step-${currentStep}`).classList.remove('active');
      document.getElementById(`step-${step}`).classList.add('active');

      currentStep = step;
    }

    async function createAccount() {
      const btn = document.getElementById('createBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Creating...';

      try {
        registrationData.planType = selectedPlan;

        const response = await fetch(`${API_URL}/api/tenants/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(registrationData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Registration failed');
        }

        // Store tokens
        localStorage.setItem('accessToken', data.tokens.accessToken);
        localStorage.setItem('refreshToken', data.tokens.refreshToken);
        localStorage.setItem('tenantSlug', data.tenant.slug);

        // Show success with API key
        document.getElementById('apiKeyDisplay').innerHTML =
          data.apiKey + '<button class="copy-btn" onclick="copyApiKey()">Copy</button>';
        document.getElementById('embedApiKey').textContent = data.apiKey;
        document.getElementById('scriptUrl').textContent = API_URL;

        // Go to success step
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.getElementById('step-4').classList.add('active');
        document.querySelectorAll('.step-dot').forEach(d => d.classList.add('completed'));

      } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }

    function copyApiKey() {
      const apiKey = document.getElementById('apiKeyDisplay').textContent.replace('Copy', '').trim();
      navigator.clipboard.writeText(apiKey);

      const btn = document.querySelector('.copy-btn');
      btn.textContent = 'Copied!';
      setTimeout(() => {
        btn.textContent = 'Copy';
      }, 2000);
    }

    function goToDashboard() {
      window.location.href = 'dashboard.html';
    }
  </script>
</body>
</html>
